name: opencode

on:
  issue_comment:
    types: [created]

jobs:
  opencode:
    if: |
      contains(github.event.comment.body, ' /oc') ||
      startsWith(github.event.comment.body, '/oc') ||
      contains(github.event.comment.body, ' /opencode') ||
      startsWith(github.event.comment.body, '/opencode')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenCode
        run: npm install -g opencode-ai@latest

      - name: Configure OpenCode for Ollama
        run: |
          mkdir -p ~/.config/opencode
          cat > ~/.config/opencode/opencode.json << 'EOF'
          {
            "$schema": "https://opencode.ai/config.json",
            "model": "ollamat/gpt-oss:120b",
            "provider": {
              "ollamat": {
                "npm": "ollama-ai-provider-v2",
                "name": "Ollama (turbo)",
                "options": {
                  "baseURL": "https://ollama.com/api",
                  "headers": {
                    "Authorization": "Bearer {env:OLLAMA_API_KEY}"
                  }
                },
                "models": {
                  "gpt-oss:20b": {
                    "name": "GPT-OSS 20B (Turbo)"
                  },
                  "gpt-oss:120b": {
                    "name": "GPT-OSS 120B (Turbo)"
                  },
                  "deepseek-v3.1:671b": {
                    "name": "DeepSeek V3.1 671B (Turbo)"
                  }
                }
              }
            }
          }
          EOF
          echo "OpenCode configured for Ollama Turbo"

      - name: Run OpenCode
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODEL: ollamat/gpt-oss:120b
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_ID: ${{ github.event.comment.id }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          echo "OpenCode version:"
          opencode --version
          
          # Extract the command from the comment
          COMMAND=$(echo "$COMMENT_BODY" | grep -oE '(/oc |/opencode ).*' | sed 's/^\/[^ ]* //')
          echo "Command: $COMMAND"
          
          # Get response from OpenCode and clean ANSI codes
          echo "Getting AI response..."
          # Capture only stdout, remove ANSI codes, and deduplicate consecutive identical lines
          RESPONSE=$(opencode run "$COMMAND" --model "$MODEL" 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g' | uniq || echo "Error: Could not get response")
          
          echo "Response: $RESPONSE"
          
          # Post response back to GitHub issue
          if [ -n "$RESPONSE" ]; then
            # Get current timestamp
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            cat > comment.md << EOF
          ## ü§ñ OpenCode Response
          
          > **Query**: $COMMAND
          
          ### üí¨ Answer
          
          $RESPONSE
          
          ---
          
          <details>
          <summary>üìä Response Details</summary>
          
          - **Model**: \`$MODEL\` 
          - **Timestamp**: $TIMESTAMP
          - **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Triggered by**: @${{ github.actor }}
          
          </details>
          
          ---
          
          <div align="center">
          
          ‚ú® **Powered by [OpenCode](https://opencode.ai) with Ollama Turbo (GPT-OSS 120B)** ‚ú®
          
          </div>
          EOF
            gh issue comment "$ISSUE_NUMBER" --body-file comment.md
          else
            echo "‚ùå No response generated"
            gh issue comment "$ISSUE_NUMBER" --body "## ‚ùå OpenCode Error
          
          Unable to generate a response for your query. Please check:
          - The API key is configured correctly
          - The model is available
          - Your query is properly formatted
          
          **Debug Info**: Check [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          fi