# Claude Code Multi-Agent Architecture

This document describes the organizational structure and orchestration patterns for the multi-agent systems in this repository.

## Directory Structure

```
.claude/
├── commands/              # Orchestration commands (user-invocable)
│   ├── research.md       # /research orchestrator
│   ├── multi-agent.md    # /multi-agent orchestrator
│   ├── levels.md         # /levels utility
│   ├── spy-levels.md     # /spy-levels utility
│   ├── qqq-levels.md     # /qqq-levels utility
│   └── README.md         # Command documentation
│
├── agents/               # Specialist agents (spawned by commands)
│   ├── meta/            # Meta-framework agents (system generation)
│   │   ├── meta-multi-agent.md      # Main system generator
│   │   ├── domain-analyzer.md       # Domain pattern analysis
│   │   ├── context-architect.md     # Context structure design
│   │   ├── orchestrator-builder.md  # Command orchestration design
│   │   ├── parallel-coordinator.md  # Parallel execution design
│   │   ├── meta-sub-agent.md        # Single agent generator
│   │   └── README.md                # Meta-framework docs
│   │
│   ├── research/        # Research system agents
│   │   ├── research-planning-agent.md  # Research plan generation
│   │   ├── web-researcher.md          # Web research execution
│   │   ├── report-synthesizer.md      # Report consolidation
│   │   ├── report-critique-agent.md   # Quality validation
│   │   ├── fact-checker.md            # Fact verification
│   │   └── research-planner.md        # Legacy planner
│   │
│   └── [domain]/        # Domain-specific agents (generated)
│       └── (Generated by /multi-agent command)
│
├── rules/               # Agent coordination rules
│   └── [domain]/       # Per-domain rules
│
├── context/            # Domain knowledge and state
│   └── [domain]/       # Per-domain context
│
├── templates/          # Reusable patterns
│   └── [domain]/       # Per-domain templates
│
└── hooks/              # Event-driven automation
    └── (Various hooks)
```

## Orchestration Hierarchy

### Level 1: User Commands
**Location**: `.claude/commands/*.md`
**Invocation**: User types `/command [args]`
**Purpose**: Coordinate entire workflows end-to-end

**Active Orchestrators**:
- `/research` → Research System Orchestrator
- `/multi-agent` → Multi-Agent System Generator

### Level 2: Specialist Agents
**Location**: `.claude/agents/[system]/*.md`
**Invocation**: Commands spawn via `Task(subagent_type="agent-name")`
**Purpose**: Execute specialized tasks within workflows

**Agent Groups**:
- `meta/` → System generation capabilities
- `research/` → Research execution capabilities
- `[domain]/` → Domain-specific capabilities (generated)

### Level 3: Tools & Resources
**Location**: Built-in tools, MCP servers, external APIs
**Invocation**: Agents call tools directly
**Purpose**: Perform atomic operations (read files, search web, etc.)

## Orchestration Patterns

### Pattern 1: `/research` Command Flow

```
User: /research [question]
  │
  ├─→ research-planning-agent (Phase 1: Planning)
  │   └─→ Returns: Research plan with streams
  │
  ├─→ web-researcher × N (Phase 2: Parallel Research)
  │   │   └─→ WebSearch, WebFetch tools
  │   └─→ Returns: N finding documents
  │
  ├─→ report-synthesizer (Phase 3: Synthesis)
  │   └─→ Returns: Consolidated report
  │
  ├─→ report-critique-agent (Phase 4: Critique)
  │   └─→ Returns: Quality assessment + iteration decision
  │
  └─→ [If critique says iterate: goto Phase 3] (Max 3 iterations)
      └─→ Final: Research report in .research/
```

### Pattern 2: `/multi-agent` Command Flow

```
User: /multi-agent [domain description]
  │
  ├─→ domain-analyzer + context-architect (Phase 2: Parallel Analysis)
  │   │   └─→ Read, Glob tools for research
  │   └─→ Returns: Domain analysis + context design
  │
  ├─→ orchestrator-builder (Phase 3: Architecture)
  │   └─→ Returns: Command orchestration spec
  │
  ├─→ meta-multi-agent (Phase 4.1: Generate Orchestrator)
  │   │   └─→ Write tool to create command file
  │   └─→ Returns: Main workflow command
  │
  ├─→ meta-multi-agent × N (Phase 4.2: Generate Agents)
  │   │   └─→ Write tool to create agent files (sequential)
  │   └─→ Returns: N specialist agents
  │
  ├─→ parallel-coordinator (Phase 4.3: Generate Rules)
  │   │   └─→ Write tool to create coordination files
  │   └─→ Returns: Coordination rules
  │
  ├─→ context-architect (Phase 4.4: Generate Context)
  │   │   └─→ Write tool to create context files
  │   └─→ Returns: Domain documentation
  │
  └─→ Final: Complete .claude system structure
```

## Agent Organization Principles

### 1. Separation by System
Agents are grouped by the orchestration system they belong to:
- **meta/** - Agents that generate other agents/systems
- **research/** - Agents that execute research workflows
- **[domain]/** - Agents that handle domain-specific operations

### 2. Framework vs Generated
- **Framework agents** (`meta/`, `research/`) - Permanent, version-controlled
- **Generated agents** (`[domain]/`) - Created by `/multi-agent`, domain-specific

### 3. Naming Conventions
- **Commands**: kebab-case, noun or verb-noun (e.g., `research.md`, `multi-agent.md`)
- **Agents**: kebab-case, role-based (e.g., `domain-analyzer.md`, `web-researcher.md`)
- **Directories**: kebab-case, system name (e.g., `meta/`, `research/`, `restaurant-kitchen/`)

## Coordination Mechanisms

### File-Based Communication
Agents coordinate through progress files:
```markdown
# progress-[stream].md
---
stream: [stream_name]
agent: [agent_name]
status: in_progress|completed|blocked
---

## Completed
- Task list

## Working On
- Current task

## Blocked
- Blockers with context
```

### State Management
Commands use TodoWrite for progress tracking:
```python
TodoWrite([
  {"content": "Phase 1", "status": "completed", "activeForm": "Completing Phase 1"},
  {"content": "Phase 2", "status": "in_progress", "activeForm": "Executing Phase 2"},
  {"content": "Phase 3", "status": "pending", "activeForm": "Pending Phase 3"}
])
```

### Error Escalation
Agents fail fast and escalate to commands, which escalate to humans:
```
Tool Error → Agent catches → Returns error to Command → Command reports to User
```

## Validation Checkpoints

### Pre-flight (Before Execution)
- Input quality validation
- Prerequisite checks
- Conflict detection

### In-flight (During Execution)
- Progress monitoring
- Intermediate validation
- Resource availability

### Post-flight (After Completion)
- Output quality validation
- Completeness checks
- Documentation generation

## Adding New Systems

### Option 1: Manual Creation
1. Create orchestrator command in `commands/[system].md`
2. Create specialist agents in `agents/[system]/`
3. Define coordination rules in `rules/[system]/`
4. Add context documentation in `context/[system]/`

### Option 2: Use `/multi-agent` (Recommended)
```bash
/multi-agent Create a system for [domain] that handles [workflows]
```

This automatically:
- Analyzes domain patterns
- Designs architecture
- Generates all files
- Validates structure
- Creates documentation

## Best Practices

### Command Design
- ✅ Use phased execution (0-N steps)
- ✅ Track progress with TodoWrite
- ✅ Run validation checkpoints
- ✅ Spawn agents in parallel when safe
- ✅ Provide concise final output

### Agent Design
- ✅ Single responsibility
- ✅ Clear coordination protocols
- ✅ Defined input/output formats
- ✅ Graceful error handling
- ✅ Progress reporting

### System Design
- ✅ File-level parallelism (no conflicts)
- ✅ Explicit coordination points
- ✅ Human escalation paths
- ✅ Comprehensive documentation
- ✅ Test incrementally

## Performance Characteristics

| System | Agents | Parallel | Sequential | Typical Runtime |
|--------|--------|----------|------------|-----------------|
| `/research` | 3-8 | web-researcher (3-5 streams) | planning → synthesis → critique | 8-15 min |
| `/multi-agent` | 5+ | analysis phase (2 agents) | generation phases | 2-5 min |

## Examples

### Research System in Action
```bash
$ /research What are the latest quantum computing error correction breakthroughs?

🔍 Creating research plan... ✓
📁 Initializing directories... ✓
🌐 Executing parallel research (5 streams)... ✓
📝 Synthesizing report... ✓
🔎 Critiquing quality... ✓
📝 Re-synthesizing (iteration 2)... ✓
🔎 Critiquing quality... ✓ (Quality sufficient)
📦 Archiving results... ✓

🎉 Research Complete!
📄 Report: .research/2025-09-29-quantum-error-correction/final/report.md
```

### Multi-Agent System in Action
```bash
$ /multi-agent Create a system for restaurant kitchen management

🔍 Analyzing domain patterns... ✓
🏗️  Designing architecture... ✓
📝 Generating orchestrator... ✓
🤖 Generating agents (5 agents)... ✓
📋 Generating coordination rules... ✓
📚 Generating context docs... ✓
✅ Validating system... ✓

🎉 Multi-Agent System Generated!
📦 System: Restaurant Kitchen Management
📁 Location: .claude/restaurant-kitchen/
📄 Documentation: .claude/restaurant-kitchen-README.md
```

## References

- **Command Documentation**: [commands/README.md](commands/README.md)
- **Meta-Framework Guide**: [agents/meta/README.md](agents/meta/README.md)
- **Research System Guide**: [agents/research/README-multi-agent-research.md](agents/research/README-multi-agent-research.md)

---

**Architecture Version**: v1.0
**Last Updated**: 2025-09-29
**Pattern Source**: Based on successful CCPM and research system implementations