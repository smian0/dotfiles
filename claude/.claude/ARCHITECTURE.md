# Claude Code Multi-Agent Architecture

This document describes the organizational structure and orchestration patterns for the multi-agent systems in this repository.

## Directory Structure

```
.claude/
â”œâ”€â”€ commands/              # Orchestration commands (user-invocable)
â”‚   â”œâ”€â”€ research.md       # /research orchestrator
â”‚   â”œâ”€â”€ multi-agent.md    # /multi-agent orchestrator
â”‚   â”œâ”€â”€ levels.md         # /levels utility
â”‚   â”œâ”€â”€ spy-levels.md     # /spy-levels utility
â”‚   â”œâ”€â”€ qqq-levels.md     # /qqq-levels utility
â”‚   â””â”€â”€ README.md         # Command documentation
â”‚
â”œâ”€â”€ agents/               # Specialist agents (spawned by commands)
â”‚   â”œâ”€â”€ meta/            # Meta-framework agents (system generation)
â”‚   â”‚   â”œâ”€â”€ meta-multi-agent.md      # Main system generator
â”‚   â”‚   â”œâ”€â”€ domain-analyzer.md       # Domain pattern analysis
â”‚   â”‚   â”œâ”€â”€ context-architect.md     # Context structure design
â”‚   â”‚   â”œâ”€â”€ orchestrator-builder.md  # Command orchestration design
â”‚   â”‚   â”œâ”€â”€ parallel-coordinator.md  # Parallel execution design
â”‚   â”‚   â”œâ”€â”€ meta-sub-agent.md        # Single agent generator
â”‚   â”‚   â””â”€â”€ README.md                # Meta-framework docs
â”‚   â”‚
â”‚   â”œâ”€â”€ research/        # Research system agents
â”‚   â”‚   â”œâ”€â”€ research-planning-agent.md  # Research plan generation
â”‚   â”‚   â”œâ”€â”€ web-researcher.md          # Web research execution
â”‚   â”‚   â”œâ”€â”€ report-synthesizer.md      # Report consolidation
â”‚   â”‚   â”œâ”€â”€ report-critique-agent.md   # Quality validation
â”‚   â”‚   â”œâ”€â”€ fact-checker.md            # Fact verification
â”‚   â”‚   â””â”€â”€ research-planner.md        # Legacy planner
â”‚   â”‚
â”‚   â””â”€â”€ [domain]/        # Domain-specific agents (generated)
â”‚       â””â”€â”€ (Generated by /multi-agent command)
â”‚
â”œâ”€â”€ rules/               # Agent coordination rules
â”‚   â””â”€â”€ [domain]/       # Per-domain rules
â”‚
â”œâ”€â”€ context/            # Domain knowledge and state
â”‚   â””â”€â”€ [domain]/       # Per-domain context
â”‚
â”œâ”€â”€ templates/          # Reusable patterns
â”‚   â””â”€â”€ [domain]/       # Per-domain templates
â”‚
â””â”€â”€ hooks/              # Event-driven automation
    â””â”€â”€ (Various hooks)
```

## Orchestration Hierarchy

### Level 1: User Commands
**Location**: `.claude/commands/*.md`
**Invocation**: User types `/command [args]`
**Purpose**: Coordinate entire workflows end-to-end

**Active Orchestrators**:
- `/research` â†’ Research System Orchestrator
- `/multi-agent` â†’ Multi-Agent System Generator

### Level 2: Specialist Agents
**Location**: `.claude/agents/[system]/*.md`
**Invocation**: Commands spawn via `Task(subagent_type="agent-name")`
**Purpose**: Execute specialized tasks within workflows

**Agent Groups**:
- `meta/` â†’ System generation capabilities
- `research/` â†’ Research execution capabilities
- `[domain]/` â†’ Domain-specific capabilities (generated)

### Level 3: Tools & Resources
**Location**: Built-in tools, MCP servers, external APIs
**Invocation**: Agents call tools directly
**Purpose**: Perform atomic operations (read files, search web, etc.)

## Orchestration Patterns

### Pattern 1: `/research` Command Flow

```
User: /research [question]
  â”‚
  â”œâ”€â†’ research-planning-agent (Phase 1: Planning)
  â”‚   â””â”€â†’ Returns: Research plan with streams
  â”‚
  â”œâ”€â†’ web-researcher Ã— N (Phase 2: Parallel Research)
  â”‚   â”‚   â””â”€â†’ WebSearch, WebFetch tools
  â”‚   â””â”€â†’ Returns: N finding documents
  â”‚
  â”œâ”€â†’ report-synthesizer (Phase 3: Synthesis)
  â”‚   â””â”€â†’ Returns: Consolidated report
  â”‚
  â”œâ”€â†’ report-critique-agent (Phase 4: Critique)
  â”‚   â””â”€â†’ Returns: Quality assessment + iteration decision
  â”‚
  â””â”€â†’ [If critique says iterate: goto Phase 3] (Max 3 iterations)
      â””â”€â†’ Final: Research report in .research/
```

### Pattern 2: `/multi-agent` Command Flow

```
User: /multi-agent [domain description]
  â”‚
  â”œâ”€â†’ domain-analyzer + context-architect (Phase 2: Parallel Analysis)
  â”‚   â”‚   â””â”€â†’ Read, Glob tools for research
  â”‚   â””â”€â†’ Returns: Domain analysis + context design
  â”‚
  â”œâ”€â†’ orchestrator-builder (Phase 3: Architecture)
  â”‚   â””â”€â†’ Returns: Command orchestration spec
  â”‚
  â”œâ”€â†’ meta-multi-agent (Phase 4.1: Generate Orchestrator)
  â”‚   â”‚   â””â”€â†’ Write tool to create command file
  â”‚   â””â”€â†’ Returns: Main workflow command
  â”‚
  â”œâ”€â†’ meta-multi-agent Ã— N (Phase 4.2: Generate Agents)
  â”‚   â”‚   â””â”€â†’ Write tool to create agent files (sequential)
  â”‚   â””â”€â†’ Returns: N specialist agents
  â”‚
  â”œâ”€â†’ parallel-coordinator (Phase 4.3: Generate Rules)
  â”‚   â”‚   â””â”€â†’ Write tool to create coordination files
  â”‚   â””â”€â†’ Returns: Coordination rules
  â”‚
  â”œâ”€â†’ context-architect (Phase 4.4: Generate Context)
  â”‚   â”‚   â””â”€â†’ Write tool to create context files
  â”‚   â””â”€â†’ Returns: Domain documentation
  â”‚
  â””â”€â†’ Final: Complete .claude system structure
```

## Agent Organization Principles

### 1. Separation by System
Agents are grouped by the orchestration system they belong to:
- **meta/** - Agents that generate other agents/systems
- **research/** - Agents that execute research workflows
- **[domain]/** - Agents that handle domain-specific operations

### 2. Framework vs Generated
- **Framework agents** (`meta/`, `research/`) - Permanent, version-controlled
- **Generated agents** (`[domain]/`) - Created by `/multi-agent`, domain-specific

### 3. Naming Conventions
- **Commands**: kebab-case, noun or verb-noun (e.g., `research.md`, `multi-agent.md`)
- **Agents**: kebab-case, role-based (e.g., `domain-analyzer.md`, `web-researcher.md`)
- **Directories**: kebab-case, system name (e.g., `meta/`, `research/`, `restaurant-kitchen/`)

## Coordination Mechanisms

### File-Based Communication
Agents coordinate through progress files:
```markdown
# progress-[stream].md
---
stream: [stream_name]
agent: [agent_name]
status: in_progress|completed|blocked
---

## Completed
- Task list

## Working On
- Current task

## Blocked
- Blockers with context
```

### State Management
Commands use TodoWrite for progress tracking:
```python
TodoWrite([
  {"content": "Phase 1", "status": "completed", "activeForm": "Completing Phase 1"},
  {"content": "Phase 2", "status": "in_progress", "activeForm": "Executing Phase 2"},
  {"content": "Phase 3", "status": "pending", "activeForm": "Pending Phase 3"}
])
```

### Error Escalation
Agents fail fast and escalate to commands, which escalate to humans:
```
Tool Error â†’ Agent catches â†’ Returns error to Command â†’ Command reports to User
```

## Validation Checkpoints

### Pre-flight (Before Execution)
- Input quality validation
- Prerequisite checks
- Conflict detection

### In-flight (During Execution)
- Progress monitoring
- Intermediate validation
- Resource availability

### Post-flight (After Completion)
- Output quality validation
- Completeness checks
- Documentation generation

## Adding New Systems

### Option 1: Manual Creation
1. Create orchestrator command in `commands/[system].md`
2. Create specialist agents in `agents/[system]/`
3. Define coordination rules in `rules/[system]/`
4. Add context documentation in `context/[system]/`

### Option 2: Use `/multi-agent` (Recommended)
```bash
/multi-agent Create a system for [domain] that handles [workflows]
```

This automatically:
- Analyzes domain patterns
- Designs architecture
- Generates all files
- Validates structure
- Creates documentation

## Best Practices

### Command Design
- âœ… Use phased execution (0-N steps)
- âœ… Track progress with TodoWrite
- âœ… Run validation checkpoints
- âœ… Spawn agents in parallel when safe
- âœ… Provide concise final output

### Agent Design
- âœ… Single responsibility
- âœ… Clear coordination protocols
- âœ… Defined input/output formats
- âœ… Graceful error handling
- âœ… Progress reporting

### System Design
- âœ… File-level parallelism (no conflicts)
- âœ… Explicit coordination points
- âœ… Human escalation paths
- âœ… Comprehensive documentation
- âœ… Test incrementally

## Performance Characteristics

| System | Agents | Parallel | Sequential | Typical Runtime |
|--------|--------|----------|------------|-----------------|
| `/research` | 3-8 | web-researcher (3-5 streams) | planning â†’ synthesis â†’ critique | 8-15 min |
| `/multi-agent` | 5+ | analysis phase (2 agents) | generation phases | 2-5 min |

## Examples

### Research System in Action
```bash
$ /research What are the latest quantum computing error correction breakthroughs?

ğŸ” Creating research plan... âœ“
ğŸ“ Initializing directories... âœ“
ğŸŒ Executing parallel research (5 streams)... âœ“
ğŸ“ Synthesizing report... âœ“
ğŸ” Critiquing quality... âœ“
ğŸ“ Re-synthesizing (iteration 2)... âœ“
ğŸ” Critiquing quality... âœ“ (Quality sufficient)
ğŸ“¦ Archiving results... âœ“

ğŸ‰ Research Complete!
ğŸ“„ Report: .research/2025-09-29-quantum-error-correction/final/report.md
```

### Multi-Agent System in Action
```bash
$ /multi-agent Create a system for restaurant kitchen management

ğŸ” Analyzing domain patterns... âœ“
ğŸ—ï¸  Designing architecture... âœ“
ğŸ“ Generating orchestrator... âœ“
ğŸ¤– Generating agents (5 agents)... âœ“
ğŸ“‹ Generating coordination rules... âœ“
ğŸ“š Generating context docs... âœ“
âœ… Validating system... âœ“

ğŸ‰ Multi-Agent System Generated!
ğŸ“¦ System: Restaurant Kitchen Management
ğŸ“ Location: .claude/restaurant-kitchen/
ğŸ“„ Documentation: .claude/restaurant-kitchen-README.md
```

## References

- **Command Documentation**: [commands/README.md](commands/README.md)
- **Meta-Framework Guide**: [agents/meta/README.md](agents/meta/README.md)
- **Research System Guide**: [agents/research/README-multi-agent-research.md](agents/research/README-multi-agent-research.md)

---

**Architecture Version**: v1.0
**Last Updated**: 2025-09-29
**Pattern Source**: Based on successful CCPM and research system implementations