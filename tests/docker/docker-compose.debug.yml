version: '3.8'

services:
  # Debug container with persistent volume for inspection
  dotfiles-debug:
    build:
      context: ../../
      dockerfile: tests/docker/Dockerfile.test
    container_name: dotfiles-debug
    volumes:
      # Mount source as read-only
      - ../../:/home/testuser/dotfiles-source:ro
      # Persistent home directory for inspection
      - debug-home:/home/testuser
      # Mount export directory for easy access
      - ./exports:/exports
    environment:
      - TEST_LEVEL=debug
      - DOTFILES_PROFILE=development
      - DEBUG=true
      - CI=false
    # Keep container running for inspection
    entrypoint: tail -f /dev/null
    stdin_open: true
    tty: true

  # Interactive test container
  dotfiles-interactive:
    build:
      context: ../../
      dockerfile: tests/docker/Dockerfile.test
    container_name: dotfiles-interactive
    volumes:
      - ../../:/home/testuser/dotfiles-source:ro
      - interactive-home:/home/testuser
      - ./exports:/exports
    environment:
      - TEST_LEVEL=interactive
      - INTERACTIVE=true
    command: /bin/bash
    stdin_open: true
    tty: true

volumes:
  debug-home:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/tests/docker/volumes/debug-home
  interactive-home:
    driver: local