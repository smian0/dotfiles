#!/bin/bash
# Secure OpenCode Launcher (oc)
# This script loads environment variables from launchctl and launches opencode
# Usage: oc [opencode arguments...]

# Debug mode - uncomment to see what's being loaded
DEBUG_MODE=false

# Load environment variables from system (launchctl)
load_env_var() {
    local var_name="$1"
    local var_value=$(launchctl getenv "$var_name" 2>/dev/null || echo "")
    if [[ -n "$var_value" ]]; then
        export "$var_name"="$var_value"
        [[ "$DEBUG_MODE" == "true" ]] && echo "Loaded $var_name: ${var_value:0:10}..."
    else
        [[ "$DEBUG_MODE" == "true" ]] && echo "Warning: $var_name not found in launchctl"
    fi
}

# Load all API keys from system environment
load_env_var "OLLAMA_API_KEY"
load_env_var "OPENAI_API_KEY" 
load_env_var "ANTHROPIC_API_KEY"
load_env_var "GITHUB_TOKEN"
load_env_var "DEEPSEEK_API_KEY"
load_env_var "GLM_API_KEY"
load_env_var "KIMI_API_KEY"
load_env_var "BRAVE_API_KEY"

# Pre-launch agent transformation
run_pre_launch_transform() {
    local sync_script="$HOME/.config/opencode/scripts/sync-claude.sh"
    
    # Only run transformation for commands that might load agents
    case "${1:-}" in
        "-h" | "--help" | "help" | "version" | "--version")
            # These commands don't load agents, skip transformation
            return 0
            ;;
        *)
            # All other commands might load agents, run transformation
            if [[ -f "$sync_script" ]]; then
                [[ "$DEBUG_MODE" == "true" ]] && echo "Running Claude to OpenCode sync..."
                if "$sync_script" 2>/dev/null; then
                    [[ "$DEBUG_MODE" == "true" ]] && echo "✅ Sync completed"
                else
                    [[ "$DEBUG_MODE" == "true" ]] && echo "⚠️  Sync had issues, proceeding anyway..."
                fi
            else
                [[ "$DEBUG_MODE" == "true" ]] && echo "⚠️  Sync script not found, proceeding..."
            fi
            ;;
    esac
}

# Detect if transform is needed due to unresolved templates in ~/.config/opencode
needs_transform() {
    local base_dir="$HOME/.config/opencode/agent"
    # If agent directory doesn't exist, prefer running transform to set it up
    if [[ ! -d "$base_dir" ]]; then
        return 0
    fi
    # Detect unresolved handlebars-style placeholders like {{DOMAIN}} 
    # but exclude files in /templates/ directories (those are meant to stay as templates)
    if command -v grep >/dev/null 2>&1; then
        if grep -R -I --exclude-dir=templates -E "\{\{[A-Z][A-Z0-9_]*\}\}" "$base_dir" >/dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

# Parse arguments: support short switch -T (and --no-transform) to skip pre-launch transform
SKIP_TRANSFORM=false
FORWARD_ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -T|--no-transform)
            SKIP_TRANSFORM=true
            ;;
        --)
            shift
            while [[ $# -gt 0 ]]; do
                FORWARD_ARGS+=("$1")
                shift
            done
            break
            ;;
        *)
            FORWARD_ARGS+=("$1")
            ;;
    esac
    shift
done

# If -T/--no-transform was provided and no other args remain, default to 'help'
if [[ "$SKIP_TRANSFORM" == "true" && ${#FORWARD_ARGS[@]} -eq 0 ]]; then
    FORWARD_ARGS+=("help")
fi

# Debug: Show final environment before launching
if [[ "$DEBUG_MODE" == "true" ]]; then
    echo "Final environment check:"
    echo "OLLAMA_API_KEY in env: ${OLLAMA_API_KEY:0:10}..."
    echo "Environment passed to opencode:"
    env | grep -E "(OLLAMA|OPENAI|ANTHROPIC|GITHUB|DEEPSEEK)" | sed 's/=.*/=***/'
fi

# Removed auto-wrapper logic to prevent corruption of npm packages
# The oc script handles environment and transformations; npm handles binary management

# Run pre-launch agent transformation (unless skipped with -T/--no-transform)
if [[ "$SKIP_TRANSFORM" != "true" ]]; then
    run_pre_launch_transform "${FORWARD_ARGS[@]}"
else
    if needs_transform; then
        echo "⚠️  Detected unresolved templates in ~/.config/opencode; running sync despite -T"
        run_pre_launch_transform "${FORWARD_ARGS[@]}"
    else
        [[ "$DEBUG_MODE" == "true" ]] && echo "Skipping pre-launch transform due to -T/--no-transform"
    fi
fi

# Launch opencode with environment variables available
# Use the current binary to ensure upgrades work properly
OPENCODE_BINARY="/Users/smian/.npm-global/bin/opencode"
OPENCODE_BACKUP="/Users/smian/.npm-global/bin/opencode.original"

# Try current binary first (this gets updated by npm)
if [[ -x "$OPENCODE_BINARY" ]]; then
    [[ "$DEBUG_MODE" == "true" ]] && echo "Using current opencode binary: $OPENCODE_BINARY"
    exec "$OPENCODE_BINARY" "${FORWARD_ARGS[@]}"
# Fallback to backup binary if current one doesn't exist
elif [[ -x "$OPENCODE_BACKUP" ]]; then
    [[ "$DEBUG_MODE" == "true" ]] && echo "Using backup opencode binary: $OPENCODE_BACKUP"
    exec "$OPENCODE_BACKUP" "${FORWARD_ARGS[@]}"
else
    echo "Error: opencode binary not found at $OPENCODE_BINARY or $OPENCODE_BACKUP" >&2
    echo "Try running: npm install -g opencode-ai" >&2
    exit 1
fi