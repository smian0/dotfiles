#!/bin/bash
# Secure OpenCode Launcher (oc)
# This script loads environment variables from launchctl and launches opencode
# Usage: oc [opencode arguments...]

# Debug mode - uncomment to see what's being loaded
DEBUG_MODE=false

# Load environment variables from system (launchctl)
load_env_var() {
    local var_name="$1"
    local var_value=$(launchctl getenv "$var_name" 2>/dev/null || echo "")
    if [[ -n "$var_value" ]]; then
        export "$var_name"="$var_value"
        [[ "$DEBUG_MODE" == "true" ]] && echo "Loaded $var_name: ${var_value:0:10}..."
    else
        [[ "$DEBUG_MODE" == "true" ]] && echo "Warning: $var_name not found in launchctl"
    fi
}

# Load all API keys from system environment
load_env_var "OLLAMA_API_KEY"
load_env_var "OPENAI_API_KEY" 
load_env_var "ANTHROPIC_API_KEY"
load_env_var "GITHUB_TOKEN"
load_env_var "DEEPSEEK_API_KEY"
load_env_var "GLM_API_KEY"
load_env_var "KIMI_API_KEY"
load_env_var "BRAVE_API_KEY"

# Pre-launch agent transformation
run_pre_launch_transform() {
    local pre_launch_script="$HOME/dotfiles/opencode/.config/opencode/scripts/pre-launch-transform.js"
    
    # Only run transformation for commands that might load agents
    case "${1:-}" in
        "" | "-h" | "--help" | "help" | "version" | "--version")
            # These commands don't load agents, skip transformation
            return 0
            ;;
        *)
            # All other commands might load agents, run transformation
            if [[ -f "$pre_launch_script" ]]; then
                [[ "$DEBUG_MODE" == "true" ]] && echo "Running pre-launch agent transformation..."
                if node "$pre_launch_script" 2>/dev/null; then
                    [[ "$DEBUG_MODE" == "true" ]] && echo "✅ Pre-launch transformation completed"
                else
                    [[ "$DEBUG_MODE" == "true" ]] && echo "⚠️  Pre-launch transformation had issues, proceeding anyway..."
                fi
            else
                [[ "$DEBUG_MODE" == "true" ]] && echo "⚠️  Pre-launch transform script not found, proceeding..."
            fi
            ;;
    esac
}

# Debug: Show final environment before launching
if [[ "$DEBUG_MODE" == "true" ]]; then
    echo "Final environment check:"
    echo "OLLAMA_API_KEY in env: ${OLLAMA_API_KEY:0:10}..."
    echo "Environment passed to opencode:"
    env | grep -E "(OLLAMA|OPENAI|ANTHROPIC|GITHUB|DEEPSEEK)" | sed 's/=.*/=***/'
fi

# Check if opencode wrapper is properly installed, auto-fix if not
check_and_fix_opencode_wrapper() {
    local opencode_bin="/Users/smian/.npm-global/bin/opencode"
    local wrapper_manager="$HOME/dotfiles/scripts/opencode-wrapper-manager.sh"
    
    # Check if opencode exists and is our wrapper
    if [[ -f "$opencode_bin" ]] && grep -q "OpenCode Direct Binary Replacement Wrapper" "$opencode_bin" 2>/dev/null; then
        return 0  # Wrapper is properly installed
    fi
    
    # Wrapper is missing or overwritten, try to reinstall
    if [[ -x "$wrapper_manager" ]]; then
        echo "🔧 OpenCode wrapper missing/overwritten, auto-reinstalling..." >&2
        if "$wrapper_manager" install >/dev/null 2>&1; then
            echo "✅ OpenCode wrapper reinstalled successfully" >&2
            return 0
        else
            echo "⚠️  Failed to reinstall OpenCode wrapper automatically" >&2
            echo "   Run: $wrapper_manager install" >&2
        fi
    else
        echo "⚠️  OpenCode wrapper missing and manager script not found" >&2
        echo "   Expected: $wrapper_manager" >&2
    fi
    
    return 1  # Could not fix wrapper
}

# Auto-fix wrapper if needed
check_and_fix_opencode_wrapper

# Run pre-launch agent transformation
run_pre_launch_transform "$@"

# Launch opencode with environment variables available
# Try to find opencode in PATH first, fallback to known locations
if command -v opencode >/dev/null 2>&1; then
    exec "$(command -v opencode)" "$@"
elif [[ -x "/Users/smian/.npm-global/bin/opencode" ]]; then
    exec /Users/smian/.npm-global/bin/opencode "$@"
else
    echo "Error: opencode not found in PATH or expected locations" >&2
    exit 1
fi